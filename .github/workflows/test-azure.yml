name: Azure Tests

on:
  merge_group:
  # Manual trigger: For testing and debugging purposes (ONLY trigger until issues are resolved)
  workflow_dispatch:
    inputs:
      test_stage:
        description: "Test stage to run"
        required: false
        default: "full-test"
        type: choice
        options:
          - network-only
          - full-test

  # Future enhancement: Add scheduled runs for nightly testing
  # schedule:
  #   - cron: '30 4 * * *'  # 10 AM IST (4:30 AM UTC) for nightly infrastructure validation

permissions:
  id-token: write # Required for OIDC
  contents: read # Required to checkout code

jobs:
  ignored_files:
    runs-on: ubuntu-latest
    name: Check for ignored files (Azure Tests)
    outputs:
      only_modified: ${{ steps.ignored-files-changed.outputs.only_modified }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for changed files
        id: ignored-files-changed
        uses: tj-actions/changed-files@v47
        with:
          files_ignore: |
            aws/**
            gcp/**
            test/aws/**
            test/gcp/**
            .github/setup/aws/**
            .github/setup/gcp/**
            azure/examples/**
            **.md
            **.env
            .gitignore
            LICENSE
            .github/workflows/test-aws*.yml
            .github/workflows/test-gcp*.yml
            .github/scripts/**
      - name: List all changed files
        run: |
          echo "Changed files: ${{ steps.ignored-files-changed.outputs.all_changed_files }}"
          echo "Are ignored Files Only modified: ${{ steps.ignored-files-changed.outputs.only_modified }}"

  test-azure:
    name: Azure Infrastructure Tests
    runs-on: ubuntu-latest
    needs: ignored_files
    # only_modified seems to be inverted, doc says it should be false but it's true when other files instead of ignored files are modified
    # https://github.com/tj-actions/changed-files?tab=readme-ov-file#output_only_modified 
    if: needs.ignored_files.outputs.only_modified == 'true'
    env:
      DURATION_SECONDS: 14400 # 4 hours

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC (for S3 backend)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.GA_AWS_IAM_ROLE }}
          role-session-name: GitHubActions-Azure-S3Backend
          aws-region: ${{ vars.TF_TEST_S3_REGION || 'us-east-1' }}
          # Max duration of the role is 8 hours as per IAM role configuration in .github/setup/aws/main.tf
          role-duration-seconds: ${{ env.DURATION_SECONDS }}

      - name: Verify AWS Authentication (for S3 backend)
        run: |
          echo "Testing AWS authentication for S3 backend..."
          aws sts get-caller-identity

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure Authentication
        run: |
          echo "Testing Azure authentication..."
          az account show
          az account list-locations --output table

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.5"
          cache-dependency-path: test/go.sum

      - name: Install dependencies
        working-directory: test
        run: go mod tidy

      - name: Run Azure Tests
        working-directory: test/azure
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          MATERIALIZE_LICENSE_KEY: ${{ secrets.MATERIALIZE_LICENSE_KEY }}
          TEST_REGION: westus2
          GITHUB_ACTIONS: "true"
          # S3 Remote Backend Configuration (for terraform state)
          TF_TEST_REMOTE_BACKEND: "true"
          TF_TEST_S3_BUCKET: ${{ vars.TF_TEST_S3_BUCKET }}
          TF_TEST_S3_REGION: ${{ vars.TF_TEST_S3_REGION || 'us-east-1' }}
          TF_TEST_S3_PREFIX: ${{ vars.TF_TEST_S3_PREFIX || 'github-actions-test-runs' }}
          # Note: AWS credentials for S3 backend provided via OIDC above
          # Azure credentials for Azure provider provided via OIDC above
          # Terratest: Set env vars to SKIP stages, unset to RUN stages
          SKIP_setup_materialize_disk_enabled: ${{ github.event.inputs.test_stage == 'network-only' && 'true' || '' }}
          SKIP_setup_materialize_disk_disabled: ${{ github.event.inputs.test_stage == 'network-only' && 'true' || '' }}
        run: |
          echo "üöÄ Running tests for Azure..."
          echo "üìÅ Current working directory: $(pwd)"
          echo "üîß Go version: $(go version)"
          echo ""
          echo "üìã Environment variables:"
          env | sort
          echo ""
          echo "üß™ Starting Go tests..."

          go test -timeout ${{ env.DURATION_SECONDS }}s -run TestStagedDeploymentSuite -v
